<VirtualHost *:{{ services.guacamole.external_port }}>
    ServerName {{ services.bastion_host.domain }}

    DocumentRoot /var/www/html
    
    ErrorLog ${APACHE_LOG_DIR}/tectonic_error.log
    CustomLog ${APACHE_LOG_DIR}/tectonic_access.log combined

    SSLEngine on
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLCertificateFile /etc/letsencrypt/live/active/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/active/privkey.pem

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerExpire off

{% if services.guacamole.enable %}
    <Location "/guacamole/">
        ProxyPass "https://{{ services.guacamole.ip }}:{{ services.guacamole.internal_port }}/"
        ProxyPassReverse "https://{{ services.guacamole.ip }}:{{ services.guacamole.internal_port }}/"
    </Location>

    <Location "/guacamole/websocket-tunnel/">
        ProxyPass "wss://{{ services.guacamole.ip }}:{{ services.guacamole.internal_port }}/websocket-tunnel"
        ProxyPassReverse "wss://{{ services.guacamole.ip }}:{{ services.guacamole.internal_port }}/websocket-tunnel"
    </Location>
{% endif %}
</VirtualHost>

{% if services.elastic.enable %}
<VirtualHost *:{{ services.elastic.external_port }}>
    ServerName {{ services.bastion_host.domain }}

    ErrorLog ${APACHE_LOG_DIR}/elastic_error.log
    CustomLog ${APACHE_LOG_DIR}/elastic_access.log combined

    SSLEngine on
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLCertificateFile /etc/letsencrypt/live/active/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/active/privkey.pem

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerExpire off
    
    ProxyPass "/" "https://{{ services.elastic.ip }}:{{ services.elastic.internal_port }}/"
    ProxyPassReverse "/" "https://{{ services.elastic.ip }}:{{ services.elastic.internal_port }}/"
</VirtualHost>
{% endif %}

{% if services.caldera.enable %}
<VirtualHost *:{{ services.caldera.external_port }}>
    ServerName {{ services.bastion_host.domain }}

    ErrorLog ${APACHE_LOG_DIR}/caldera_error.log
    CustomLog ${APACHE_LOG_DIR}/caldera_access.log combined

    SSLEngine on
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLCertificateFile /etc/letsencrypt/live/active/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/active/privkey.pem

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerExpire off

    ProxyPass "/" "https://{{ services.caldera.ip }}:{{ services.caldera.internal_port }}/"
    ProxyPassReverse "/" "https://{{ services.caldera.ip }}:{{ services.caldera.internal_port }}/"
</VirtualHost>
{% endif %}

{% if services.moodle.enable %}
<VirtualHost *:{{ services.moodle.external_port }}>
    ServerName {{ services.bastion_host.domain }}

    ErrorLog ${APACHE_LOG_DIR}/moodle_error.log
    CustomLog ${APACHE_LOG_DIR}/moodle_access.log combined

    SSLEngine on
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLCertificateFile /etc/letsencrypt/live/active/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/active/privkey.pem

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerExpire off

    ProxyPreserveHost On
    ProxyPass "/" "https://{{ services.moodle.ip }}:{{ services.moodle.internal_port }}/"
    ProxyPassReverse "/" "https://{{ services.moodle.ip }}:{{ services.moodle.internal_port }}/"
</VirtualHost>
{% endif %}
