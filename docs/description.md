# Lab Configuration
The lab configuration is divided in two: a [scenario
specification](#scenario-specification) that holds a static
description of the lab that can be shared and reused, and information
specific to a particular [lab edition](#lab-edition-information) that
defines things such as number of instances to deploy, public SSH keys
for the teachers, etc.


## Scenario Specification
A lab description consists of the following resources:

* A scenario description file in YAML syntax (required).
* Ansible playbooks for *base image* installation and *after-clone*
  configurations, and optional files in the `ansible` directory.
* Elastic and kibana policies and resources, in the `elastic`
  directory, if using elastic for evaluation.

### Scenario description
The scenario description is a YAML file with three main sections: 

* A global section with the following options:
  + `institution`: The institution that created the lab. Must be alphanumeric. Required.
  + `lab_name`: The lab name. Must be alphanumeric. Required.
  + `default_os`: The default operating system to use for guests. Must
    be one of `ubuntu22`, `rocky8` or `kali`. Optional, default:
    `ubuntu22`.

* A `guest_settings` section in which all guest machines of the lab
  are described. Each guest entry has these options (all are
  optional):
  + `entry_point`: Whether the trainees can access the machine through
    SSH or RDP. Default: `no`.
  + `memory`: Amount of RAM of the machine, in MB. Default: `1024`.
  + `vcpu`: Number of virtual CPUs of the machine. Default: `1`.
  + `disk`: Amount of disk of the machine, in GB. Default: `10`.
  + `base_os`: The operating system of the guest. Must be one of
    `ubuntu22`, `rocky8`, `kali` or `windows_srv_2022`. Default is
    taken from the global `default_os` description attribute mentioned
    above.
  + `internet_access`: Whether the guest has internet access. Note
    that this might be expensive on AWS, since a NAT gateway is
    deployed in the lab VPC. Default: `no`.
  + `copies`: The number of copies of this guest to deploy in each
    instance. Default: `1`.
  + `monitor`: Whether to monitor this guest using [Elastic Security](https://www.elastic.co/security). This option is ignored if `elastic_settings.enable` is `no`. Note that in AWS if this is `yes` and `elastic_settings.monitor_type` is `traffic`, the deployed instance type is selected from the `T3` instances, instead of `T2`. Default: `no`.
  + `red_team_agent`: Whether a [Caldera](https://caldera.mitre.org) agent will be installed in the guest for the automatic execution of red team type tasks. This option is ignored if `caldera_settings.enable` is `no`. Default: `no`
  + `blue_team_agent`: Whether a Caldera agent will be installed in the guest for the automatic execution of blue team type tasks. This option is ignored if `caldera_settings.enable` is `no`. Default: `no`

* A `topology` section with the network definition. This should be a
  list of networks with a `name` and a list of `members` which must be
  one of the defined guests in the previous section.

+ A `elastic_settings` section to describe the configuration of the Elastic Security service. The following properties must be defined:
  + `enable`: Wheter to deploy this service. Default: `no`.
  + `monitor_type`: How to monitor instances. Possible values are: 
      - `traffic`: Packetbeat is used to monitor only network traces generated by the instances.
      - `endpoint`: Elastic Endpoint is used to monitor processes, network traces, files, system logs, among others. Keep in mind that this installs an Elastic agent on the machines to be monitored. You must generate the base images of the instances you want to monitor in order for Tectonic to install the Elastic agent.
    
    Default: `traffic`.
  + `deploy_default_policy`: Whether the default policy should be deployed for monitoring the instances. If `elastic_setting.monitor_type` is `traffic`, then a policy named according to the value of the `packetbeat_policy_name` (see [ini_config](./ini_config.md)) property will be deployed that will only collect network traces (includes protocols such as HTTP, DNS, TLS, among others). If `elastic_setting.monitor_type` is `endpoint` then a policy named according to the value of the `endpoint_policy_name` (see [ini_config](./ini_config.md)) property will be deployed that will collect operating system logs, audit logs and events such as processes, network connections, file modifications, among others events. Default: `yes`.

+ A `caldera_settings` section to describe the configuration of the Caldera service. The following properties must be defined:
  + `enable`: Wheter to deploy this service. Default: `no`.

A complete example description file with all available options
follows:

```
---
institution: udelar
lab_name: password_cracking
default_os: ubuntu22

guest_settings:
  attacker:
    entry_point: yes
    # Default values: 
    memory: 1024
    vcpu: 1
    disk: 10
    base_os: ubuntu22
    internet_access: no
    copies: 1
    monitor: no
    red_team_agent: no
    blue_team_agent: no
  victim:
    # Default values: 
    entry_point: no
    memory: 1024
    vcpu: 1
    disk: 10
    base_os: ubuntu22
    internet_access: no
    copies: 1
    monitor: no
    red_team_agent: no
    blue_team_agent: no

topology:
  - name: internal
    members: 
      - attacker
      - victim

elastic_settings:
 # Default values:
 enable: no
 monitor_type: traffic
 deploy_default_policy: yes

caldera_settings:
  # Default values:
  enable: no
``` 

This specification defines a lab called `password_cracking` by
`udelar`. It consists of two instances of a scenario with two machines
(a `victim` and an `attacker`) connected to an `internal` network.
Both are machines with `1GB` of RAM and 1 virtual cpu, running ubuntu
22.04. Trainees will connect to the Cyber Range through the `attacker`
machine. Both Elastic Security and Caldera services are disabled.

### Ansible playbooks
Guest machine configuration is done with Ansible. The **inventory** is
created automatically by tectonic. The user should provide (if
necessary) two playbooks:

* `ansible/base_config.yml`: This playbook runs when the base image
  for the guest is created. Internet access is available. The following
  variables are available in the playbook:
  + `instances`: The total number of configured instances. This is the
    same as the `instance_number` attribute of the lab edition file.
  + `basename`: The base name of the guest machine as configured in
    the `guest_settings` section of the description file (e.g.
    `victim`).
* `ansible/after_clone.yml`: This playbook runs after the guest
  machines are cloned. There is no internet access. In addition to the
  variables available in `base_config.yml` (`instances` and
  `basename`), the following variables are available in the playbook:
  + `instance`: The instance number of this machine.
  + `copy`: The copy number of this machine.

Tectonic defines host groups for each guest ~~and for each network~~
defined in the lab, so that ansible plays can be conveniently applied
to a group of machines. For example, this play will apply to all
`attacker` machines in the lab:

```
- name: "Attacker configuration"
  hosts: attacker

  tasks:
    ...
```

### Elastic Security artifacts

Elastic Security configuration is done based on artifacts that are automatically imported into the Elasticsearch, Kibana and Fleet components. As part of the scenario specification, these artifacts must be provided. See [Elastic](./elastic.md) for more information.

### Caldera artifacts
Caldera configuration is done based on artifacts that are automatically imported into Caldera. As part of the scenario specification, these artifacts must be provided. See [Caldera](./caldera.md) for more information.


## Lab Edition Information
The lab edition is a YAML file with the following options:
  + `base_lab`: The name of the lab in the configured repository. See
    `lab_repo_uri` in the [ini configuration file](ini_config.md).
    Required.
  + `institution`: The institution that offers this edition of the
    lab. Optional, default: the institution of the base lab.
  + `lab_edition_name`: The name of this edition of the lab. Optional,
    default: the name of the base lab.
  + `instance_number`: The number of instances of the lab to deploy.
    Required.
  + `teacher_pubkey_dir`: A directory containing the SSH public keys
    of all teachers that need to connect to the lab machines. Relative
    paths will be assumed to be relative to the directory where the
    lab edition file is located. Optional, default: only the public
    key specified in the `ssh_public_key_file` option in the ini file
    will be added.
  + `student_prefix`: The prefix to use in the usernames for the
    students. An instance number is appended at the end. Optional,
    default: `trainee`.
  + `student_pubkey_dir`: A directory containing a subdirectory for
    each student, with SSH public keys. Optional, defaults to not
    setting any public key in the users authorized_keys file.
  + `create_student_passwords`: Whether to create a pseudo-random
    password for the students. These passwords are printed on
    deployment and student-access execution. Optional, defaults to
    `false`.
  + `random_seed`: Seed used for the random generation of parameters that are used to configure and parameterize the instances.
  + A `elastic_settings` section with the following options: 
    + `enable`:  Whether to enable the Elastic Security service. For the service to be effectively enabled, it must also be enabled in the scenario description. Ultimately, this option is useful if you want to disable the service in case the scenario uses it. Default: `yes`
    + `memory`: Amount of RAM of the machine, in MB. Default: `8192`.
    + `vcpu`: Number of virtual CPUs of the machine. Default: `4`.
    + `disk`: Amount of disk of the machine, in GB. Default: `50`.
  + A `caldera_settings` section with the following options: 
    + `enable`: Whether to enable the Caldera service. For the service to be effectively enabled, it must also be enabled in the scenario description. Ultimately, this option is useful if you want to disable the service in case the scenario uses it. Default: `yes`
    + `memory`: Amount of RAM of the machine, in MB. Default: `2048`.
    + `vcpu`: Number of virtual CPUs of the machine. Default: `2`.
    + `disk`: Amount of disk of the machine, in GB. Default: `20`.

A complete example lab edition file with all available options
follows:

```
---
base_lab: password_cracking
institution: udelar
lab_edition_name: fsi_2024_lab2
teacher_pubkey_dir: ./teacher_pubkeys

elastic_settings:
  enable: yes
  memory: 8192
  vpcu: 4
  disk: 50

caldera_settings:
  enable: yes
  memory: 2048
  vpcu: 2
  disk: 20
```


### SSH Public keys
In addition to the `ssh_public_key_file` option configured in the ini
file, a list of public keys can be added to the admin account in all
machines of the Cyber Range. This account is intended for teacher
access.

The keys must be placed inside the `teacher_pubkey_dir` directory and
are automatically copied by Tectonic during the deployment phase.

The default user to connect to each machine depends on the operating
system:

| **SO**           | **Admin username** |
|:----------------:|:------------------:|
| ubuntu22         | ubuntu             |
| kali             | kali               |
| rocky8           | rocky              |
| windows_srv_2022 | Administrator      |


