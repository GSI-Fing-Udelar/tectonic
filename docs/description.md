# Lab Configuration
The lab configuration is divided in two: a [scenario
specification](#scenario-specification) that holds a static
description of the lab that can be shared and reused, and information
specific to a particular [lab edition](#lab-edition-information) that
defines things such as number of instances to deploy, public SSH keys
for the teachers, etc.


## Scenario Specification
A lab description consists of the following resources:

* A scenario description file in YAML syntax (required).
* Ansible playbooks for *base image* installation and *after-clone*
  configurations, and optional files in the `ansible` directory.
* Elastic and kibana policies and resources, in the `elastic`
  directory, if using elastic for evaluation.
* Caldera resources in the `caldera` directory  if using caldera for adversary emulation.

### Scenario description file
The scenario description is a YAML file with three main sections: 

* A global section with the following options:
  + `institution`: The institution that created the lab. Must be alphanumeric. Required.
  + `lab_name`: The lab name. Must be alphanumeric. Required.
  + `default_os`: The default operating system to use for guests. Must
    be one of `ubuntu22`, `ubuntu24`, `rocky8`, `rocky9` or `kali`. Optional, default:
    `ubuntu22`.

* A `guest_settings` section in which all guest machines of the lab
  are described. Each guest entry has these options (all are
  optional):
  + `entry_point`: Whether the trainees can access the machine through
    SSH or RDP. Default: `no`. See [remote_access](./remote_access.md) for more details.
  + `memory`: Amount of RAM of the machine, in MB. Default: `1024`.
  + `vcpu`: Number of virtual CPUs of the machine. Default: `1`.
  + `disk`: Amount of disk of the machine, in GB. Default: `10`.
  + `gpu`: Whether the machine has a GPU. Only supported in AWS for
    now (this is costly, a `g4dn.xlarge` instance is used). Default:
    `no`.
  + `gui`: Whether to install GUI on the machine to allow access via graphical interface (RDP/VNC) if using Guacamole. Default: `no`.
  + `base_os`: The operating system of the guest. Must be one of
    `ubuntu22`, `ubuntu24`, `rocky8`, `rocky9`, `kali` or `windows_srv_2022`.
    Default is taken from the global `default_os` description
    attribute mentioned above.
  + `internet_access`: Whether the guest has internet access. Note
    that this might be expensive on AWS, since a NAT gateway is
    deployed in the lab VPC. Default: `no`.
  + `copies`: The number of copies of this guest to deploy in each
    instance. Default: `1`.
  + `monitor`: Whether to monitor this guest using [Elastic Security](https://www.elastic.co/security). This option is ignored if `elastic_settings.enable` is `no`. Note that in AWS if this is `yes` and `elastic_settings.monitor_type` is `traffic`, the deployed instance type is selected from the `T3` instances, instead of `T2`. Default: `no`.
  + `red_team_agent`: Whether a [Caldera](https://caldera.mitre.org) agent will be installed in the guest for the automatic execution of red team type tasks. This option is ignored if `caldera_settings.enable` is `no`. Default: `no`
  + `blue_team_agent`: Whether a Caldera agent will be installed in the guest for the automatic execution of blue team type tasks. This option is ignored if `caldera_settings.enable` is `no`. Default: `no`

* A `topology` section with the network definition. This should be a
  list of networks with a `name` and a list of `members` which must be
  one of the defined guests in the previous section. See [network_topology](./network_topology.md) for more details.

+ A `elastic_settings` section to describe the configuration of the Elastic Security service. The following properties can be defined:
  + `enable`: Whether to deploy this service. Default: `no`.
  + `memory`: Amount of RAM of the machine, in MB. Default: `8192`.
  + `vcpu`: Number of virtual CPUs of the machine. Default: `4`.
  + `disk`: Amount of disk of the machine, in GB. Default: `50`.
  + `monitor_type`: How to monitor instances. Possible values are: 
      - `traffic`: Packetbeat is used to monitor only network traces
        generated by the instances.
      - `endpoint`: Elastic Endpoint is used to monitor processes,
        network traces, files, system logs, among others. Keep in mind
        that this installs an Elastic agent on the machines to be
        monitored. Default: `traffic`.
  + `deploy_default_policy`: Whether the default policy should be
    deployed for monitoring the instances. If
    `elastic_setting.monitor_type` is `traffic`, then a policy named
    according to the value of the `packetbeat_policy_name` option (see
    [ini_config](./ini_config.md)) will be deployed that will only
    collect network traces (includes protocols such as HTTP, DNS, TLS,
    among others). If `elastic_setting.monitor_type` is `endpoint`
    then a policy named according to the value of the
    `endpoint_policy_name` (see [ini_config](./ini_config.md))
    property will be deployed that will collect operating system logs,
    audit logs and events such as processes, network connections, file
    modifications, among others events. Default: `yes`.

+ A `caldera_settings` section to describe the configuration of the Caldera service. The following properties can be defined:
  + `enable`: Whether to deploy this service. Default: `no`.
  + `memory`: Amount of RAM of the machine, in MB. Default: `2048`.
  + `vcpu`: Number of virtual CPUs of the machine. Default: `2`.
  + `disk`: Amount of disk of the machine, in GB. Default: `20`.

+ A `guacamole_settings` section to describe the configuration of the Guacamole service. The following properties can be defined:
  + `enable`: Whether to deploy this service. Default: `no`.
  + `memory`: Amount of RAM of the machine, in MB. Default: `2048`.
  + `vcpu`: Number of virtual CPUs of the machine. Default: `2`.
  + `disk`: Amount of disk of the machine, in GB. Default: `20`.

+ A `moodle_settings` section to describe the configuration of the [Moodle service](./moodle.md). The following properties can be defined:
  + `enable`: Whether to deploy this service. Default: `no`.
  + `memory`: Amount of RAM of the machine, in MB. Default: `4096`.
  + `vcpu`: Number of virtual CPUs of the machine. Default: `2`.
  + `disk`: Amount of disk of the machine, in GB. Default: `20`.
  + `enable_trainees`: Whether student users should be automatically configured. Default: `yes`.
  + `auto_enroll_trainees`: Whether users should be enroll in the courses. Default: `yes`.

A complete example description file with all available options is available in the [example directory](../examples/password_cracking/description.yml).

This specification defines a lab called `password_cracking` by
`udelar`. It consists of two instances of a scenario with two machines
(a `victim` and an `attacker`) connected to an `internal` network.
Both are machines with `1GB` of RAM and 1 virtual cpu, running ubuntu
22.04. Trainees will connect to the Cyber Range through the `attacker`
machine. Both Elastic Security and Caldera services are disabled.

### Ansible playbooks
Guest machine configuration is done with Ansible. The *inventory* is
created automatically by tectonic. The user should provide (if
necessary) two playbooks:

* `ansible/base_config.yml`: This playbook runs when the base image
  for the guest is created. Internet access is available. The following
  variables are available in the playbook:
  + `instances`: The total number of configured instances. This is the
    same as the `instance_number` attribute of the lab edition file.
  + `basename`: The base name of the guest machine as configured in
    the `guest_settings` section of the description file (e.g.
    `victim`).
* `ansible/after_clone.yml`: This playbook runs after the guest
  machines are cloned. There is no internet access. In addition to the
  variables available in `base_config.yml` (`instances` and
  `basename`), the following variables are available in the playbook:
  + `instance`: The instance number of this machine.
  + `copy`: The copy number of this machine.

Tectonic defines host groups for each guest ~~and for each network~~
defined in the lab, so that ansible playbooks can be conveniently
applied to a group of machines. For example, this playbook will apply
to all `attacker` machines in the lab:

```
- name: "Attacker configuration"
  hosts: attacker

  tasks:
    ...
```

Optionally, the user can provide a set of parameters to be used in the playbooks. For example, these parameters can be flags to be uniquely configured for each instance. To do this, a `ansible/parameters` directory must be created and files with the .ndjson extension should be placed there, where each line of the file must be a JSON object containing the parameters.

See [ansible](./ansible.md) for more information.

### Elastic Security artifacts
Elastic Security configuration is done based on artifacts that are automatically imported into the Elasticsearch, Kibana and Fleet components. These artifacts must be provided as part of the scenario specification in the `elastic` directory. See [Elastic](./elastic.md) for more information.

### Caldera artifacts
Caldera configuration is done based on artifacts that are automatically imported into Caldera. These artifacts must be provided as part of the scenario specification in the `caldera` directory. See [Caldera](./caldera.md) for more information.

### Moodle artifacts
Moodle configuration can be done based on course backup files that are automatically imported into Moodle. These artifacts must be provided as part of the scenario specification in the `moodle` directory . See [Moodle](./moodle.md) for more information.

## Lab Edition Information
The lab edition is a YAML file with the following options:
  + `base_lab`: The name of the lab in the configured repository. See
    `lab_repo_uri` in the [ini configuration file](ini_config.md).
    Required.
  + `institution`: The institution that offers this edition of the
    lab. Optional, default: the institution of the base lab.
  + `lab_edition_name`: The name of this edition of the lab. Optional,
    default: the name of the base lab.
  + `instance_number`: The number of instances of the lab to deploy.
    Required.
  + `teacher_pubkey_dir`: A directory containing the SSH public keys
    of all teachers that need to connect to the lab machines. Relative
    paths will be assumed to be relative to the directory where the
    lab edition file is located. Optional, default: only the public
    key specified in the `ssh_public_key_file` option in the ini file
    will be added.
  + `student_prefix`: The prefix to use in the usernames for the
    students. An instance number is appended at the end. Optional,
    default: `trainee`. The instance number, padded with enough zeros
    for the total number of instances in the scenario, is appended to
    this prefix to generate student usernames (so that for 20
    instances users will go from `trainee01` to `trainee20`)
  + `student_pubkey_dir`: A directory containing a subdirectory for
    each student, with SSH public keys. Optional, defaults to not
    setting any public key in the users authorized_keys file. For
    example, if 3 instances of a scenario are deployed and
    student_prefix is trainee, then three subdirectories: `trainee1`,
    `trainee2`, and `trainee3` must be created within the
    `student_pubkey_dir` directory. Inside each subdirectory, files
    containing the public keys of the students corresponding to each
    instance should be placed. In general, this directory should be
    organized as follows:
    ```
    <student_pubkey_dir>/
            ├── <student_prefix>1/
            │       ├── key1.pub
            │       │
            │       └── keyM.pub
            │      ...
            └─ <student_prefix>N/
                    ├── key1.pub
                    │
                    └── keyM.pub
    ```
  + `create_students_passwords`: Whether to create a pseudo-random
    password for the students to access machines. These passwords are
    printed on deployment and student-access execution. Optional, defaults to
    `false`. If the guacamole service is enabled or the Moodle service is enabled
    and the option to auto-generate student users was selected, then this option 
    takes the value `true`.
  + `random_seed`: Seed used for the random generation of parameters
    that are used to configure and parameterize the instances.
  + Four optional `elastic_settings`, `caldera_settings`, `guacamole_settings` 
    and `moodle_settings` sections with the same options as the scenario
    description. Options here take precedence on the scenario
    description. For the service to be effectively enabled, it must be
    enabled here and in the scenario description. Ultimately, the
    `enable` option here is useful if you want to disable the service
    in case the scenario uses it.

A complete example lab edition file with all available options is
available in the [example
directory](../examples/password_cracking.yml).

