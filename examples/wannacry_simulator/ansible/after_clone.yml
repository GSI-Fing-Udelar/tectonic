---
# ==============================================================================
# WannaCry Ransomware Simulator - Main Playbook (after_clone.yml)
# ==============================================================================
# This playbook runs AFTER the instances are cloned from the base image.
# It executes the complete WannaCry simulation using Layer 3 orchestration.
#
# ARCHITECTURE:
#   Layer 3 (Profile) - execute_ransomware_profile module
#       ‚Üì calls layer3_ransomwareprofile.py
#   Layer 2 (Orchestrators) - Bulk operations via layer2_orchestrators.py
#       ‚Üì uses layer1_primitives.py
#   Layer 1 (Primitives) - Atomic file operations
#
# EXECUTION CONTEXT (provided by Tectonic):
#   - instances: Total number of instances (from lab edition)
#   - instance: Current instance number (1, 2, 3, ...)
#   - copy: Copy number within instance
#   - basename: Base name of the guest (e.g., "victim")
#   - parameter: Instance-specific parameters (if any)
#   - random_seed: Seed for reproducible randomization
#
# PLAYBOOK FLOW:
#   1. Install system dependencies (ent, osquery)
#   2. Execute WannaCry profile via execute_ransomware_profile module
#   3. Provide forensic analysis instructions
#
# NOTES:
#   - No internet connection available (after_clone runs in isolated network)
#   - All dependencies must be installed in base_config.yml
#   - Custom modules loaded from tectonic/ansible/library/ automatically
#   - Layer 3 orchestrator handles all simulation logic
# ==============================================================================

- name: "WannaCry Ransomware Simulation - Victim Machine"
  hosts: victim
  gather_facts: yes
  become: yes
  
  # Pre-tasks: Ensure forensic tools are installed
  # These tools will be used for post-simulation analysis
  pre_tasks:
    - name: "Display simulation start message"
      debug:
        msg:
          - "=============================================="
          - "  STARTING WANNACRY RANSOMWARE SIMULATION"
          - "=============================================="
          - "Instance: {{ instance }}"
          - "Copy: {{ copy }}"
          - "Target: {{ basename }}"
          - "Random Seed: {{ random_seed | default('not set') }}"
          - "=============================================="
    
    - name: "Update apt cache"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
    
    - name: "Install forensic tools for post-simulation analysis"
      apt:
        name:
          - ent
          - osquery
          - python3
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"
    
    - name: "Install Python dependencies for encryption"
      pip:
        name:
          - cryptography
          - faker
          - openpyxl
        state: present
        executable: pip3
    
      when: ansible_virtualization_type != 'docker'  # Skip in Docker containers
  
  # Main tasks: Execute WannaCry simulation
  tasks:
    - name: "[SETUP] Create target directory"
      file:
        path: "{{ target_directory }}"
        state: directory
        mode: '0755'
    
    - name: "[IDEMPOTENCY] Check if simulation already executed"
      stat:
        path: "{{ target_directory }}/.wannacry_executed"
      register: simulation_marker
    
    - name: "[IDEMPOTENCY] Skip if already executed"
      debug:
        msg: "Simulation already executed. Use force_rerun=true to re-execute."
      when: 
        - simulation_marker.stat.exists
        - not force_rerun
    
    - name: "[LAYER 3] Execute WannaCry ransomware profile"
      execute_ransomware_profile:
        profile: "wannacry"
        target_directory: "{{ target_directory }}"
        file_count: "{{ file_count }}"
        faker_seed: "{{ faker_seed }}"
        force_rerun: "{{ force_rerun }}"
        deletion_ratio: "{{ deletion_ratio }}"
      register: wannacry_result
      when: not simulation_marker.stat.exists or force_rerun
    
    - name: "WannaCry Simulation Summary"
      debug:
        msg:
          - "=============================================="
          - "       WANNACRY SIMULATION COMPLETE"
          - "=============================================="
          - ""
          - "Status: {% if simulation_marker.stat.exists and not force_rerun %}Skipped (already executed){% else %}Executed successfully{% endif %}"
          - "Profile: {{ wannacry_result.profile_name | default('WannaCry') }}"
          - "Target: {{ target_directory }}"
          - ""
          - "Results:"
          - "  Files generated: {{ wannacry_result.files_generated | default('N/A') }}"
          - "  Files encrypted: {{ wannacry_result.files_encrypted | default('N/A') }}"
          - "  Files deleted: {{ wannacry_result.files_deleted | default('N/A') }}"
          - "  Encryption key: {{ wannacry_result.encryption_key[:32] | default('N/A') }}..."
          - "  Execution time: {{ wannacry_result.execution_time | default('N/A') }}s"
          - ""
          - "Extension: .WNCRY"
          - "Algorithm: AES-256-CBC"
          - "Ransom note: @Please_Read_Me@.txt"
      when: wannacry_result is defined
  
  # Variables for simulation
  vars:
    target_directory: "/srv/samba/share"
    file_count: 150
    faker_seed: "{{ random_seed | default(42) }}"
    force_rerun: false
    deletion_ratio: 12
    encrypted_extension: "WNCRY"
  
  # Post-tasks: Display analysis instructions
  post_tasks:
    - name: "Display post-simulation instructions"
      debug:
        msg:
          - "=============================================="
          - "       SIMULATION COMPLETED SUCCESSFULLY"
          - "=============================================="
          - ""
          - "üìÅ Infected Directory: {{ target_directory }}"
          - "üîê Encryption Method: AES-256-CBC (REAL)"
          - "üéØ Encrypted Extension: .{{ encrypted_extension }}"
          - ""
          - "üîç FORENSIC ANALYSIS COMMANDS:"
          - ""
          - "1. View encrypted files:"
          - "   ls -lh {{ target_directory }}/"
          - "   find {{ target_directory }} -name '*.{{ encrypted_extension }}'"
          - ""
          - "2. Count encrypted files:"
          - "   find {{ target_directory }} -name '*.{{ encrypted_extension }}' | wc -l"
          - ""
          - "3. View ransom note:"
          - "   cat {{ target_directory }}/@Please_Read_Me@.txt"
          - ""
          - "4. Verify encryption with hexdump:"
          - "   hexdump -C $(find {{ target_directory }} -name '*.{{ encrypted_extension }}' | head -1) | head -20"
          - ""
          - "5. Analyze file entropy (detect encryption):"
          - "   find {{ target_directory }} -name '*.{{ encrypted_extension }}' | head -5 | xargs -I {} sh -c 'echo \"File: {}\"; ent {}'"
          - ""
          - "6. Query file types:"
          - "   find {{ target_directory }} -name '*.{{ encrypted_extension }}' | head -10 | xargs file"
          - ""
          - "7. Inspect timestamps:"
          - "   stat $(find {{ target_directory }} -name '*.{{ encrypted_extension }}' | head -5)"
          - ""
          - "8. Run forensic analyzer (comprehensive analysis):"
          - "   python3 /tmp/wannacry_forensics_analyzer.py {{ target_directory }}"
          - ""
          - "=============================================="
          - "‚ö†Ô∏è  CRITICAL WARNING:"
          - "   Files are REALLY encrypted with AES-256-CBC"
          - "   They CANNOT be recovered without the key"
          - "   This is for TRAINING purposes ONLY"
          - "=============================================="
      when: not ansible_check_mode

# ==============================================================================
# FORENSIC ANALYST WORKSTATION CONFIGURATION (Optional)
# ==============================================================================
# This play prepares the analyst machine with tools and scripts for
# investigating the infected victim machine remotely
# ==============================================================================

- name: "Forensic Analysis Workstation Setup"
  hosts: analyst
  gather_facts: yes
  become: yes
  
  tasks:
    - name: "Install forensic analysis tools"
      apt:
        name:
          - ent
          - osquery
          - python3
          - python3-pip
          - wireshark-common
          - tcpdump
          - binutils
          - hexedit
        state: present
      when: ansible_os_family == "Debian"
    
    - name: "Install Python forensic libraries"
      pip:
        name:
          - cryptography
          - pefile
        state: present
        executable: pip3
  