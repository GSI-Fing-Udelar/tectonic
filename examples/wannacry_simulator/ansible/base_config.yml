---
# ==============================================================================
# WannaCry Simulator - Base Image Configuration (base_config.yml)
# ==============================================================================
# This playbook runs DURING base image creation (Packer phase).
# It installs all necessary dependencies that require internet access.
#
# EXECUTION CONTEXT:
#   - Runs on the base image before cloning
#   - Internet connection is AVAILABLE
#   - Variables: instances, basename
#
# PURPOSE:
#   Install all system packages and dependencies needed for the simulation
#   since after_clone.yml runs in an isolated network without internet access.
#
# INSTALLED COMPONENTS:
#   1. Forensic tools (auditd, ent, osquery)
#   2. Python and pip
#   3. Python libraries (cryptography, faker, openpyxl)
#   4. System utilities (pandoc for PDF generation)
# ==============================================================================

- name: "Install WannaCry Simulator Dependencies - Base Image"
  hosts: victim
  gather_facts: yes
  become: yes
  
  tasks:
    - name: "Display base configuration message"
      debug:
        msg:
          - "=============================================="
          - "  CONFIGURING BASE IMAGE FOR WANNACRY SIMULATOR"
          - "=============================================="
          - "Installing dependencies with internet access"
          - "This runs BEFORE instance cloning"
          - "=============================================="
    
    # =========================================================================
    # STEP 1: Update package cache
    # =========================================================================
    - name: "Update apt package cache"
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
    
    # =========================================================================
    # STEP 1.5: Install GPG (required for apt_key module)
    # =========================================================================
    - name: "Install GPG tools (required for repository key management)"
      apt:
        name:
          - gnupg
          - gpg
          - ca-certificates
        state: present
      when: ansible_os_family == "Debian"
    
    # =========================================================================
    # STEP 2: Create working directories
    # =========================================================================
    - name: "Create simulation working directory"
      file:
        path: /opt/wannacry_simulator
        state: directory
        mode: '0755'
    
    - name: "Create logs directory"
      file:
        path: /var/log/wannacry_simulator
        state: directory
        mode: '0755'
    
    - name: "Display installation summary"
      debug:
        msg:
          - "=============================================="
          - "   BASE IMAGE CONFIGURATION COMPLETED"
          - "=============================================="
          - ""
          - "üìÅ Working Directory: /opt/wannacry_simulator"
          - "üìã Logs Directory: /var/log/wannacry_simulator"
          - ""
          - "üéØ Next Phase: Instance cloning and simulation execution"
          - "=============================================="

# ==============================================================================
# ANALYST WORKSTATION BASE CONFIGURATION
# ==============================================================================
- name: "Install Forensic Tools - Analyst Workstation Base Image"
  hosts: analyst
  gather_facts: yes
  become: yes
  
  tasks:
    - name: "Display analyst workstation configuration complete"
      debug:
        msg:
          - "=============================================="
          - "   ANALYST WORKSTATION BASE CONFIGURED"
          - "=============================================="
          - "Ready for forensic investigation tasks"
